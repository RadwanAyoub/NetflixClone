name: Auto Assign Reviewers

on:
  pull_request:
    types: [ready_for_review]
    branches: [ master ]

permissions:
  pull-requests: write
  contents: read

jobs:
  assign-smart-reviewers:
    name: Assign Smart Reviewers
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.repo.full_name == github.event.pull_request.base.repo.full_name
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Read reviewer configuration
      id: config
      uses: actions/github-script@v7
      with:
        script: |
          const configPath = '.github/reviewers.yml';
          const configContent = await github.rest.repos.getContent({
            owner: context.repo.owner,
            repo: context.repo.repo,
            path: configPath,
          });
          
          const config = YAML.parse(Buffer.from(configContent.data.content, 'base64').toString());
          return config;

    - name: Assign reviewers based on configuration
      uses: actions/github-script@v7
      with:
        script: |
          const { data: files } = await github.rest.pulls.listFiles({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.payload.pull_request.number,
          });

          const config = ${{ steps.config.outputs.result }};
          const reviewers = new Set();
          const team_reviewers = new Set();

          // Add default reviewers
          (config.default?.reviewers || []).forEach(reviewer => reviewers.add(reviewer));
          (config.default?.team_reviewers || []).forEach(team => team_reviewers.add(team));

          // Check file patterns and assign specialized reviewers
          for (const patternGroup of config.file_patterns || []) {
            for (const file of files) {
              const matchesPattern = patternGroup.patterns.some(pattern => 
                minimatch(file.filename, pattern)
              );
              
              if (matchesPattern) {
                patternGroup.reviewers?.forEach(reviewer => reviewers.add(reviewer));
                patternGroup.team_reviewers?.forEach(team => team_reviewers.add(team));
                break; // No need to check other patterns for this file group
              }
            }
          }

          // Convert to arrays and assign
          const reviewersArray = Array.from(reviewers);
          const teamReviewersArray = Array.from(team_reviewers);

          console.log('Smart reviewers assignment:');
          console.log('Reviewers:', reviewersArray);
          console.log('Team Reviewers:', teamReviewersArray);

          await github.rest.pulls.requestReviewers({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.payload.pull_request.number,
            reviewers: reviewersArray,
            team_reviewers: teamReviewersArray,
          });